<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>backbone-survey/examples</title>
<script type="text/javascript" src="../lib/json2/json2.js"></script>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/underscore/underscore-min.js"></script>
<script type="text/javascript" src="../lib/backbone/backbone-min.js"></script>
<script type="text/javascript" src="../assets/js/backbone-survey.js"></script>
<script type="text/javascript">
(function($) {
  $(function() {
    var survey = new BackboneSurvey.Survey({
      survey: {
        title: "テストアンケート"
      , page: 0
      }
    , sections: [
        {
          id: "startup"
        , page: 1
        , contents: {
            question: "回答なしのセクションです。案内文を表示することができます。"
          }
        }
      , {
          id: 'Invalid ID!!(^^;)'
        , page: 1
        , contents: {
            question: "IDに利用可能な文字は [-_0-9a-zA-Z]+ です。不正IDの設問は読み込まれません"
          }
        }
      , {
          id: "q1"
        , page: 2
        , type: BackboneSurvey.QuestionType.TEXT
        , contents: {
            // ビュー要素は :contents 内にセットします。
            // テンプレートをカスタマイズすれば任意のキーであらゆるビュー要素を渡せます。
            //----------------------------------------------
            // SectionView
            //----------------------------------------------
            // title - 設問タイトル
            question: "Q1. 単一テキスト入力設問です。<strong><em>HTMLタグはエスケープされません</em></strong>"
            //----------------------------------------------
            // TextAnswerView
            //----------------------------------------------
            // prefix - 前テキスト
          , prefix: "<strong>ラベル：</strong>"
            // suffix - 後テキスト
          , suffix: "<em>(2..10文字以内)</em>"
            //----------------------------------------------
          }
        , rules: [
            new BackboneSurvey.RequiredValidator({ message: "入力してください" })
          , new BackboneSurvey.RangeLengthValidator(
              { message: "2..10文字以内で入力してください" , min: 2 , max: 10 })
          ]
        }
      , {
          id: "q2"
        , page: 2
        , type: BackboneSurvey.QuestionType.RADIO
        , contents: {
            question: "Q2. 単一選択設問です。page 値を合わせることで、複数設問を表示できます。"
          }
        , options: [
            { value: "1", label: "はい", route: "Y" }
          , { value: "2", label: "いいえ", route: "N" }
          , { value: "0", label: "どちらともいえない<em>タグが使えます</em>", sub: { placeholder: "どちらともいえない理由は？" } }
          ]
        , rules: [
            new BackboneSurvey.RequiredValidator({ message: "選択してください" })
          ]
        }
      , {
          id: "q3"
        , page: 3
        , type: BackboneSurvey.QuestionType.MULTI
        , contents: {
            question: "Q3. 複数テキスト設問です。"
          }
        , fields: [
            {
              label: "サブ設問1 <em>(HTMLタグはエスケープされません)</em>"
            , rules: [
                new BackboneSurvey.RequiredValidator({
                  message: "サブ設問1を入力してください"
                })
              ]
            }
          , {
              label: "サブ設問2"
            , rules: [
                new BackboneSurvey.RangeLengthValidator({
                  message: "サブ設問2は10文字以内で入力してください"
                , max: 10
                })
              ]
            }
          , {
              label: "サブ設問3"
            , rules: [
                new BackboneSurvey.PatternValidator({
                  message: "サブ設問3はアルファベットで入力してください"
                , pattern: "^(?:|[a-zA-Z]+)$"
                })
              ]
            }
          , { label: "サブ設問4" }
          ]
        }
      , {
          id: "q4"
        , page: 4
        , routeDependencies: [["Y", "N"]] // Y or N いずれかを選択した場合に表示されます。
        , type: BackboneSurvey.QuestionType.CHECKBOX
        , contents: {
            question: "Q4. 複数選択設問です。(未選択可)"
          }
        , options: [
            { value: "A", label: '<img src="images/yellow.gif"> スポーツ', route: "ANY", sub: { placeholder: "好きなスポーツ" } }
          , { value: "B", label: '<img src="images/cyan.gif"> 読書', route: "ANY", sub: { placeholder: "好きな本" } }
          , { value: "C", label: '<img src="images/magenta.gif"> 映画鑑賞', route: "ANY", sub: { placeholder: "好きな映画" } }
          , { value: "NONE", label: '<img src="images/black.gif"> 特になし' }
          , { value: "OTHER", label: "その他", route: "OTHER", sub: {} }
          ]
        // 背反値です。
        , singleOptions: ["NONE", "OTHER"]
        // 初期値です。背反制御と矛盾しているため "NONE" のチェックは外れます。
        , defaultAnswers: ["B", "C", "NONE"]
        }
      , {
          id: "q5"
        , page: 5
        , routeDependencies: ["Y", ["ANY", "OTHER"]] // Y && (ANY || OTHER) を選択した場合に表示されます。
        , type: BackboneSurvey.QuestionType.CHECKBOX
        , contents: {
            question: "Q5. 複数選択設問です。(選択必須)"
          }
        , options: [ "赤", "緑", "青" ] // ラベルを省略して値のみ指定できます。
        , rules: [
            new BackboneSurvey.RequiredValidator({ message: "選択してください" })
          ]
        }
      ]
    }, { parse: true });

    var view = new BackboneSurvey.SurveyView({
      model: survey // BackboneSurvey.Survey
    , el: $("#survey-app") // ビュー構築先の jQuery オブジェクト
    });

    // ページ移動時に Survey の :change イベントが呼ばれます。
    var lastPage = survey.sections.lastPage();
    survey.on("change", function() {
      console.log(survey.get("page") + " of " + lastPage);
    });

    if (false) {
      // ブラウザ履歴移動を利用しない
      view.on("start", function() { survey.startPage() } );
      view.on("prev", function() { survey.prevPage() } );
      view.on("next", function() { survey.nextPage() } );

    } else {
      // ブラウザ履歴移動を利用する
      var Workspace = Backbone.Router.extend({
        routes: {
          "page/:n": "page"
        }

      , prevPages: []
      , nextPages: []

      , start: function() {
        this.prevPages = [survey.get("page")];
        this.nextPages = [];
        this.navigate("page/" + survey.get("page"));
      }

      , next: function() {
        this.prevPages.push(survey.get("page"));
        this.nextPages = [];
        this.navigate("page/" + survey.get("page"));
      }

      , completed: function() {
        this.prevPages = [];
        this.nextPages = [];
        this.navigate("completed");
      }

      , page: function(n) {
          if (this.prevPages.length > 1 && this.prevPages[this.prevPages.length - 2] == n) {
            this.nextPages.push(this.prevPages.pop());
            survey.prevPage();
          } else if (this.nextPages.length > 0 && this.nextPages[this.nextPages.length - 1] == n) {
            this.prevPages.push(this.nextPages.pop());
            survey.nextPage();
          }
          console.log([n, this.prevPages, this.nextPages]);
        }
      });

      var router = new Workspace();
      view.on("start", function() {
        survey.startPage();
        router.start();
      });
      view.on("prev", function() {
        history.back();
      });
      view.on("next", function() {
        survey.nextPage();
        router.next();
      });
      view.on("completed", function() {
        console.log(["completed", survey.answers()]);
        router.completed();
      });

      Backbone.history.start();
    }

    // 回答時に SurveyView から answer フックが呼ばれます。
    view.on("answer", function() {
      // SurveyView#isValid で正常回答の判定ができます
      console.log(["answer", view.isValid()]);
    });

    // アニメーション
    view.beforeRender = function($el) {
      // 次の設問の描画前に呼ばれます。
      // SurveyView#render(); で次設問の描画を開始させる必要があります。
      $el.fadeOut("slow", function() { view.render(); });
    };
    view.afterRender = function($el) {
      // 次の設問の描画後に呼ばれます。
      // Survey#rendered == true で描画完了とみなされ、回答が可能になります。
      console.log(["afterRender", view.isValid()]);
      $el.fadeIn("slow", function() { view.rendered = true; });
    };

    // SurveyView#startPage() でアンケート開始します。
    view.startPage();
  });
})(jQuery);
</script>
</head>
<body>
  <div id="survey-app">
    <h1 class="survey-title"></h1><!-- アンケートタイトル -->
    <div id="survey-sections"></div><!-- アンケート設問(必須) -->
    <input type="button" class="survey-next" value="Next"><!-- 次ページに進みます(必須) -->
    <input type="button" class="survey-prev" value="Prev"><!-- 前ページに戻ります -->
    <p><a class="survey-start" href="javascript:void(0);">はじめからやり直す</a></p>
  </div>
</body>
</html>
