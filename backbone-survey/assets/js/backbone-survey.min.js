var BackboneSurvey=BackboneSurvey||{};(function(){BackboneSurvey.VERSION="0.0.0",BackboneSurvey.Extendable={extend:Backbone.Model.extend}})();var BackboneSurvey=BackboneSurvey||{};(function(){var e=function(){};BackboneSurvey.AnswerType={},BackboneSurvey.AnswerType.NONE=new e,BackboneSurvey.AnswerType.TEXT=new e,BackboneSurvey.AnswerType.OPTION=new e;var t=function(e,t){this._answerType=e,this._multiple=t};t.prototype={answerType:function(){return this._answerType},multiple:function(){return this._multiple}},BackboneSurvey.QuestionType={},BackboneSurvey.QuestionType.NONE=new t(BackboneSurvey.AnswerType.NONE,!1),BackboneSurvey.QuestionType.TEXT=new t(BackboneSurvey.AnswerType.TEXT,!1),BackboneSurvey.QuestionType.RADIO=new t(BackboneSurvey.AnswerType.OPTION,!1),BackboneSurvey.QuestionType.CHECKBOX=new t(BackboneSurvey.AnswerType.OPTION,!0)})();var BackboneSurvey=BackboneSurvey||{};(function(){var e=BackboneSurvey.ValidationResult=function(e){this.message=e||""};e.prototype={valid:!0},_.extend(e,BackboneSurvey.Extendable),e.OK=e.extend({valid:!0}),e.Error=e.extend({valid:!1});var t=BackboneSurvey.Validator=function(e){this.attributes=e||{}};t.prototype={validate:function(t,n){return new e.OK},message:function(e){return e=e||{},_.isString(this.attributes.template)?_.template(this.attributes.template)(_.extend(this.attributes,e)):this.attributes.message||""}},_.extend(t,BackboneSurvey.Extendable),BackboneSurvey.RequiredValidator=t.extend({validate:function(t,n){var r=_.isArray(t)?t:[t],i;if(r.length===0)i=new e.Error(this.message());else{var s=this;_.each(r,function(t){if(i)return;_.isNumber(t)&&(t=t.toString()),_.isEmpty(t)&&(i=new e.Error(s.message()))}),i||(i=new e.OK)}return i}}),BackboneSurvey.RangeLengthValidator=t.extend({validate:function(t,n){var r=_.isArray(t)?t:[t],i,s=this;return _.each(r,function(t){if(i)return;_.isNumber(t)&&(t=t.toString());var n=_.isNumber(s.attributes.min)?s.attributes.min:null,r=_.isNumber(s.attributes.max)?s.attributes.max:null;if(n&&n>t.length||r&&r<t.length)i=new e.Error(s.message())}),i||(i=new e.OK),i}})})();var BackboneSurvey=BackboneSurvey||{};(function(){var e=BackboneSurvey.Section=Backbone.Model.extend({constructor:function(){Backbone.Model.apply(this,arguments)},defaults:{page:0,routeDependencies:[],type:BackboneSurvey.QuestionType.NONE,question:"",label:"",guide:"",options:[],singleOptions:[],answers:[],defaultAnswers:[],rules:[]},set:function(e,t,n){if(e===null)return this;typeof e=="object"?(attrs=e,n=t):(attrs={})[e]=t,typeof attrs.id!="undefined"&&(attrs.id=attrs.id.toString()),typeof attrs.page!="undefined"&&(attrs.page=_.isNumber(attrs.page)?parseInt(attrs.page,10):0);if(typeof attrs.options!="undefined"){var r=attrs.options||[];attrs.options=[],_.each(r,function(e){typeof e!="object"&&(e={value:e.toString(),label:e.toString()}),attrs.options.push(e)})}Backbone.Model.prototype.set.call(this,attrs,n)},validate:function(e,t){var n=[],r=this.answers(e),i=this;_.each(this.attributes.rules,function(e){if(n.length>0)return;var t=e.validate(r,i.attributes);t.valid||n.push(t.message)});if(n.length>0)return n},answers:function(e){return e=e||this.attributes,e.answers},clearAnswers:function(){this.set({answers:[]},{silent:!0})},answeredRoutes:function(){var e=[],t=this.get("options");switch(this.get("type")){case BackboneSurvey.QuestionType.RADIO:case BackboneSurvey.QuestionType.CHECKBOX:var n=this.answers();_.each(n,function(n){_.each(_.where(t,{value:n}),function(t){typeof t.route=="string"&&!_.isEmpty(t.route)&&e.push(t.route)})});break;default:}return _.uniq(e)}}),t=BackboneSurvey.Sections=Backbone.Collection.extend({model:e,firstPage:function(){return this.reduce(function(e,t){var n=t.get("page");return e===0||e>n?n:e},0)},lastPage:function(){return this.reduce(function(e,t){var n=t.get("page");return e===0||e<n?n:e},0)},prevPage:function(e){var t=[];return this.each(function(n){var r=n.get("page");r<e&&t.push(r)}),t=_.sortBy(t,function(e){return-1*e}),t.length>0?t[0]:e===0?this.firstPage():e},nextPage:function(e){var t=[];this.each(function(n){var r=n.get("page");r>e&&t.push(r)}),t=_.sortBy(t,function(e){return e});var n=this.lastPage();return t.length>0?t[0]:e===0||n<e?n:e}}),n=BackboneSurvey.Survey=Backbone.Model.extend({constructor:function(){this.sections=new t,this.routeResolver={},this.routeResolver.prototype={resolve:function(e,t){return e}},Backbone.Model.apply(this,arguments)},defaults:{title:"",page:0,answeredSectionIds:[]},parse:function(e,t){return this.sections.reset(_.filter(e.sections||[],function(e){return e.id.toString().match(/^[-_0-9a-zA-Z]+$/)})),e.survey||{}},startPage:function(){this.set("answeredSectionIds",[]),this.sections.each(function(e){e.clearAnswers(),e.set({answers:e.get("defaultAnswers")})});var e=this.sections.firstPage();this.set({page:e})},prevPage:function(){var e=this.sections.prevPage(this.get("page"));e!=this.get("page")&&this.set({page:e})},nextPage:function(){var e=this.answeredRoutes(),t=0,n=this.get("page");do{n=this.sections.nextPage(n);if(n===this.get("page")){t=n;break}var r=this.sections.where({page:n}),i=r.length;for(var s=0;s<r.length;s++){var o=!0,u=r[s].get("routeDependencies")||[];for(var a=0;a<u.length;a++){var f=_.difference(e,_.flatten([u[a]]));o=_.difference(e,f).length>0;if(!o)break}o||i--}if(i>0){t=n;break}}while(n<this.sections.lastPage());t>0?this.set({page:t}):this.trigger("completed")},isFirstPage:function(){return this.get("page")===this.sections.firstPage()},isLastPage:function(){return this.get("page")===this.sections.lastPage()},currentSections:function(){return this.sections.where({page:this.get("page")})},answers:function(){var e=this,t=[],n=this.get("answeredSectionIds")||[];return _.each(n,function(n){var r=e.sections.get(n);if(!r)return;if(r.get("type")===BackboneSurvey.QuestionType.NONE)return;t.push({id:r.id,answers:r.get("answers")})}),t},addAnsweredSectionId:function(e){var t=this.sections.get(e);if(!t)return;var n=this.get("answeredSectionIds")||[];n.push(e),this.set("answeredSectionIds",_.uniq(n))},answeredRoutes:function(){var e=[],t=this.get("answeredSectionIds")||[],n=this;return _.each(t,function(t){var r=n.sections.get(t);r&&(e=_.union(e,r.answeredRoutes()))}),e}})})();var BackboneSurvey=BackboneSurvey||{};(function(){BackboneSurvey.SurveyView=Backbone.View.extend({elPrefix:"survey-",templates:{error:"<ul><% _.each(errors, function(error) { %><li><%- error %></li><% }); %></ul>"},initialize:function(){this.$el.hide();var e={};e["click ."+this.elPrefix+"start"]="startPage",e["click ."+this.elPrefix+"prev"]="prevPage",e["click ."+this.elPrefix+"next"]="nextPage",this.delegateEvents(e),this.$title=this.$("."+this.elPrefix+"title"),this.$sections=this.$("#"+this.elPrefix+"sections"),this.sectionView={},this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"completed",this.complete)},render:function(){BackboneSurvey.logger&&BackboneSurvey.logger.debug(["SurveyView#render",this.model]),this.$title.html(this.model.get("title")||""),this.$sections.html(""),this.sectionViewMap={};if(this.model.get("page")>0){var t=this,n=this.model.currentSections();_.each(n,function(n){var r=t.sectionViewMap[n.id]=new e({model:n,className:t.elPrefix+"section"});r.render(),r.$("."+t.elPrefix+"error").html("").hide(),t.$sections.append(r.el)}),this.model.isFirstPage()?this.$("."+this.elPrefix+"prev").hide():this.$("."+this.elPrefix+"prev").show(),this.$el.show()}else this.$el.hide();return this},startPage:function(){this.model.startPage()},prevPage:function(){this.model.prevPage()},nextPage:function(){var e=!0,t=_.keys(this.sectionViewMap),n=this;_.each(t,function(t){var r=n.model.sections.get(t);if(!r)return;r.clearAnswers();var i=n.sectionViewMap[t],s=i.$("."+n.elPrefix+"error");s.html("").hide(),r.set({answers:i.answers()},{validate:!0}),r.validationError&&(e=!1,s.html(_.template(n.templates.error)({errors:r.validationError})).show())}),e&&(_.each(t,function(e){n.model.addAnsweredSectionId(e)}),this.model.isLastPage()?this.complete():this.model.nextPage())},complete:function(){this.$el.html(""),this.trigger("completed",this)}});var e=BackboneSurvey.SectionView=Backbone.View.extend({tagName:"div",template:'<div class="<%- elPrefix %>question"><span class="<%- elPrefix %>question-title"><%= model.question %></span></div><div id="<%- elPrefix %>error-<%- model.id %>" class="<%- elPrefix %>error"></div><div id="<%- elPrefix %>answer-<%- model.id %>" class="<%- elPrefix %>answer"></div>',initialize:function(){this.elPrefix=this.elPrefix||"survey-",this.answerView=t.create(this)},render:function(){return this.$el.html(_.template(this.template)({elPrefix:this.elPrefix,model:this.model.toJSON()})),this.$("#"+this.elPrefix+"answer-"+this.model.id).html(this.answerView.render().el),this},answers:function(){return this.answerView?this.answerView.answers():[]}}),t=BackboneSurvey.AnswerViewFactory={};t.create=function(e){var t;switch(e.model.get("type")){case BackboneSurvey.QuestionType.TEXT:t=BackboneSurvey.TextAnswerView;break;case BackboneSurvey.QuestionType.RADIO:t=BackboneSurvey.RadioAnswerView;break;case BackboneSurvey.QuestionType.CHECKBOX:t=BackboneSurvey.CheckboxAnswerView;break;default:t=BackboneSurvey.NoneAnswerView}return new t({model:e.model,tagName:"div",className:e.elPrefix+"answer-item"})};var n=BackboneSurvey.NoneAnswerView=Backbone.View.extend({render:function(){return this},answers:function(){return[]}}),r=BackboneSurvey.TextAnswerView=Backbone.View.extend({template:'<%= label %><input type="text" name="answer-<%- id %>"<% if (answers.length !== 0) { %> value="<%- answers[0] %>"<% } %>><%= guide %>',render:function(){return this.$el.html(_.template(this.template)(this.model.toJSON())),this},answers:function(){var e=this.$('[name="answer-'+this.model.id+'"]').val();return _.isEmpty(e)?[]:[e]}}),i={render:function(){this.$el.html(_.template(this.template)(this.model.toJSON()));var e=this,t=function(){e.normalize($(this))};return this.$('input[name^="answer-"]').each(t).on("change",t),this},normalize:function(e){var t=this.model.get("singleOptions");if(e.prop("checked")){var n=e.val(),r=_.contains(t,n)?function(){return this.value!=n}:function(){return _.contains(t,this.value)};this.$('input[name^="answer-"]').filter(r).prop("checked",!1).removeAttr("checked")}},answers:function(){var e=[];return this.$('[name="answer-'+this.model.id+'"]').each(function(){var t=$(this);t.prop("checked")&&e.push(t.val())}),e}},s=BackboneSurvey.RadioAnswerView=Backbone.View.extend({template:'<ul><% _.each(options, function(option) { %><li><label><input type="radio" name="answer-<%- id %>" value="<%- option.value %>"<% if (_.contains(answers, option.value)) { %> checked="checked"<% } %>><%- option.label %></label></li><% }); %></ul>'});_.extend(s.prototype,i);var o=BackboneSurvey.CheckboxAnswerView=Backbone.View.extend({template:'<ul><% _.each(options, function(option) { %><li><label><input type="checkbox" name="answer-<%- id %>" value="<%- option.value %>"<% if (_.contains(answers, option.value)) { %> checked="checked"<% } %>><%- option.label %></label></li><% }); %></ul>'});_.extend(o.prototype,i)})();