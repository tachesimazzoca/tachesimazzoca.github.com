var BackboneSurvey=BackboneSurvey||{};(function(){BackboneSurvey.VERSION="0.1.3",BackboneSurvey.Extendable={extend:Backbone.Model.extend}})();var BackboneSurvey=BackboneSurvey||{};(function(){var e=function(){};BackboneSurvey.AnswerType={},BackboneSurvey.AnswerType.NONE=new e,BackboneSurvey.AnswerType.TEXT=new e,BackboneSurvey.AnswerType.OPTION=new e,BackboneSurvey.AnswerType.MATRIX=new e;var t=function(e,t){this._answerType=e,this._multiple=t};t.prototype={answerType:function(){return this._answerType},multiple:function(){return this._multiple}},BackboneSurvey.QuestionType={},BackboneSurvey.QuestionType.NONE=new t(BackboneSurvey.AnswerType.NONE,!1),BackboneSurvey.QuestionType.TEXT=new t(BackboneSurvey.AnswerType.TEXT,!1),BackboneSurvey.QuestionType.MULTI=new t(BackboneSurvey.AnswerType.TEXT,!0),BackboneSurvey.QuestionType.RADIO=new t(BackboneSurvey.AnswerType.OPTION,!1),BackboneSurvey.QuestionType.CHECKBOX=new t(BackboneSurvey.AnswerType.OPTION,!0),BackboneSurvey.QuestionType.MATRIX=new t(BackboneSurvey.AnswerType.MATRIX,!1),BackboneSurvey.QuestionType.MATRIX_MULTI=new t(BackboneSurvey.AnswerType.MATRIX,!0)})();var BackboneSurvey=BackboneSurvey||{};(function(){var e=BackboneSurvey.ValidationResult=function(e){this.message=e||""};e.prototype={valid:!0},_.extend(e,BackboneSurvey.Extendable),e.OK=e.extend({valid:!0}),e.Error=e.extend({valid:!1});var t=BackboneSurvey.Validator=function(e){this.attributes=e||{}};t.prototype={validate:function(t,n){return new e.OK},message:function(e){return e=e||{},_.isString(this.attributes.template)?_.template(this.attributes.template)(_.extend(this.attributes,e)):this.attributes.message||""}},_.extend(t,BackboneSurvey.Extendable),BackboneSurvey.RequiredValidator=t.extend({validate:function(t,n){var r=_.isArray(t)?t:[t],i;if(r.length===0)i=new e.Error(this.message());else{var s=this;_.each(r,function(t){if(i)return;_.isNumber(t)&&(t=t.toString()),_.isEmpty(t)&&(i=new e.Error(s.message()))}),i||(i=new e.OK)}return i}}),BackboneSurvey.PatternValidator=t.extend({validate:function(t,n){var r=_.isArray(t)?t:[t],i,s=new RegExp(this.attributes.pattern),o=this;return _.each(r,function(t){if(i)return;_.isString(t)||(t=typeof t!="undefined"&&t!==null?t.toString():""),t.match(s)||(i=new e.Error(o.message()))}),i||(i=new e.OK),i}}),BackboneSurvey.RangeLengthValidator=t.extend({validate:function(t,n){var r=_.isArray(t)?t:[t],i,s=this;return _.each(r,function(t){if(i)return;_.isString(t)||(t=typeof t!="undefined"&&t!==null?t.toString():"");var n=_.isNumber(s.attributes.min)?s.attributes.min:null,r=_.isNumber(s.attributes.max)?s.attributes.max:null;if(n&&n>t.length||r&&r<t.length)i=new e.Error(s.message())}),i||(i=new e.OK),i}})})();var BackboneSurvey=BackboneSurvey||{};(function(){var e=BackboneSurvey.SectionResolver=function(e,t){this.dependencies=e||[],this.strict=t?!0:!1};e.prototype={resolve:function(e){var t=this.dependencies,n=[];_.each(e,function(e){n=_.union(n,e.routes)});var r=!0;for(var i=0;i<t.length;i++){var s=_.difference(n,_.flatten([t[i]]));r=_.difference(n,s).length>0;if(!r)break}return r&&this.strict&&(_.each(t,function(e){var t=_.flatten([e]);_.each(t,function(e){n=_.without(n,e)})}),r=n.length===0),r}}})();var BackboneSurvey=BackboneSurvey||{};(function(){var e=BackboneSurvey.Section=Backbone.Model.extend({constructor:function(){Backbone.Model.apply(this,arguments)},defaults:{page:0,routeDependencies:[],type:BackboneSurvey.QuestionType.NONE,contents:{},fields:[],options:[],singleOptions:[],defaultAnswers:[],rules:[],answers:[],subAnswer:{}},set:function(e,t,n){if(e===null)return this;typeof e=="object"?(attrs=e,n=t):(attrs={})[e]=t,typeof attrs.id!="undefined"&&(attrs.id=attrs.id.toString()),typeof attrs.page!="undefined"&&(attrs.page=_.isNumber(attrs.page)?parseInt(attrs.page,10):0),typeof attrs.contents!="undefined"&&typeof attrs.contents!="object"&&(attrs.contents={});if(typeof attrs.options!="undefined"){var r=attrs.options||[];attrs.options=[],_.each(r,function(e){typeof e!="object"&&(e={value:e,label:e}),e.label=e.label||e.value,e.value=e.value.toString(),e.label=e.label.toString(),typeof e.route!="undefined"&&(e.route=e.route.toString()),attrs.options.push(e)})}Backbone.Model.prototype.set.call(this,attrs,n)},validate:function(e,t){var n=[],r=this.answers(e),i=this,s=this.get("fields")||[];this.get("type")===BackboneSurvey.QuestionType.MULTI?_.each(s,function(e,t){var s=e.rules||[],o=[];_.each(s,function(e){if(o.length>0)return;var s=e.validate([r[t]],i.attributes);s.valid||n.push(s.message)}),_.union(n,o)}):this.get("type").answerType()===BackboneSurvey.AnswerType.MATRIX?_.each(s,function(e,t){var s=e.rules||[],o=[];_.each(s,function(e){if(o.length>0)return;var s=e.validate(r[t],i.attributes);s.valid||n.push(s.message)}),_.union(n,o)}):_.each(this.attributes.rules,function(e){if(n.length>0)return;var t=e.validate(r,i.attributes);t.valid||n.push(t.message)});if(n.length>0)return n},answers:function(e){return e=e||this.attributes,e.answers},clearAnswers:function(){this.set({answers:[]},{silent:!0})},answeredRoutes:function(){var e=[],t=this.get("options");switch(this.get("type")){case BackboneSurvey.QuestionType.RADIO:case BackboneSurvey.QuestionType.CHECKBOX:var n=this.answers();_.each(n,function(n){_.each(_.where(t,{value:n}),function(t){typeof t.route=="string"&&!_.isEmpty(t.route)&&e.push(t.route)})});break;default:}return _.uniq(e)}}),t=BackboneSurvey.Sections=Backbone.Collection.extend({model:e,firstPage:function(){return this.reduce(function(e,t){var n=t.get("page");return e===0||e>n?n:e},0)},lastPage:function(){return this.reduce(function(e,t){var n=t.get("page");return e===0||e<n?n:e},0)},prevPage:function(e){var t=[];return this.each(function(n){var r=n.get("page");r<e&&t.push(r)}),t=_.sortBy(t,function(e){return-1*e}),t.length>0?t[0]:e===0?this.firstPage():e},nextPage:function(e){var t=[];this.each(function(n){var r=n.get("page");r>e&&t.push(r)}),t=_.sortBy(t,function(e){return e});var n=this.lastPage();return t.length>0?t[0]:e===0||n<e?n:e}}),n=BackboneSurvey.Survey=Backbone.Model.extend({constructor:function(){this.sections=new t,Backbone.Model.apply(this,arguments)},defaults:{title:"",page:0,answeredSectionIds:[],options:{}},parse:function(e,t){return this.sections.reset(_.filter(e.sections||[],function(e){return e.id.toString().match(/^[-_0-9a-zA-Z]+$/)})),e.survey||{}},initAnswers:function(e,t){e=e||0,t=t||{};var n=this.get("answeredSectionIds");this.sections.each(function(t){t.get("page")>e&&(_.without(n,t.id),t.clearAnswers(),t.set({answers:t.get("defaultAnswers")},{silent:!0}))}),this.set({page:e,answeredSectionIds:n},t)},startPage:function(){this.initAnswers(0,{silent:!1});var e=this.sections.firstPage();this.set({page:e})},prevPage:function(){var e=this.get("page"),t=_.sortBy(this.availablePages(),function(e){return e});t.reverse();var n=e;for(var r=0;r<t.length;r++)if(t[r]<n){n=t[r];break}if(n!=this.get("page")){var i=this.get("options").resetOn||[];_.contains(i,"prev")?this.initAnswers(n):this.set({page:n})}},nextPage:function(){var e=this,t=_.pluck(this.currentSections(),"id");_.each(t,function(t){e.addAnsweredSectionId(t)});if(this.isLastPage()){this.trigger("completed");return}var n=this.get("page"),r=_.sortBy(this.availablePages(),function(e){return e}),i=this.sections.firstPage();for(var s=0;s<r.length;s++)if(r[s]>n){i=r[s];break}if(i>n){var o=this.get("options").resetOn||[];_.contains(o,"next")&&this.initAnswers(n,{silent:!0}),this.set({page:i})}else this.trigger("completed")},isFirstPage:function(){return this.get("page")===this.sections.firstPage()},isLastPage:function(){return this.get("page")===this.sections.lastPage()},currentSections:function(){return this.sections.where({page:this.get("page")})},answers:function(){var e=this,t=[],n=this.get("answeredSectionIds")||[];return _.each(n,function(n){var r=e.sections.get(n);if(!r)return;if(r.get("type")===BackboneSurvey.QuestionType.NONE)return;t.push({id:r.id,answers:r.get("answers"),subAnswer:r.get("subAnswer")})}),t},addAnsweredSectionId:function(e){var t=this.sections.get(e);if(!t)return;var n=t.get("page"),r=[],i=this.get("answeredSectionIds")||[],s=this;_.each(i,function(e){var t=s.sections.get(e);if(!t)return;t.get("page")<=n&&r.push(e)}),r.push(e),this.set("answeredSectionIds",_.uniq(r),{silent:!0})},answeredRoutes:function(){var e=[],t=this.get("answeredSectionIds")||[],n=this;return _.each(t,function(t){var r=n.sections.get(t);r&&e.push({id:t,routes:r.answeredRoutes()})}),e},availablePages:function(){var e=this.answeredRoutes(),t=this.get("page"),n=this.sections.firstPage(),r=[n];if(n>t)return r;do{n=this.sections.nextPage(n);var i=this.sections.where({page:n}),s=i.length;for(var o=0;o<i.length;o++){var u=i[o].get("resolver")||new BackboneSurvey.SectionResolver(i[o].get("routeDependencies")||[]);u.resolve(e)||s--}if(s>0){r.push(n);if(n>t)break}}while(n<this.sections.lastPage());return _.sortBy(r,function(e){return e})},serializeStatus:function(){var e={};return e.page=this.get("page")||0,e.answeredSectionIds=this.get("answeredSectionIds")||[],e.answers=[],this.sections.each(function(t){e.answers.push({id:t.id,answers:t.get("answers"),subAnswer:t.get("subAnswer")})}),JSON.stringify(e)},unserializeStatus:function(e,t){var n;t=t||{},this.initAnswers(0,{silent:!0});var r;try{r=JSON.parse(e)}catch(i){return console.log(i),!1}if(typeof r!="object"||!r)return!1;r.page=r.page||0;if(this.sections.lastPage()<r.page)return!1;r.answeredSectionIds=r.answeredSectionIds||[];for(n=0;n<r.answeredSectionIds.length;n++)if(!this.sections.get(r.answeredSectionIds[n]))return!1;r.answers=r.answers||[];for(n=0;n<r.answers.length;n++){var s=this.sections.get(r.answers[n].id);if(!s)return!1;var o={answers:r.answers[n].answers,subAnswer:r.answers[n].subAnswer};if(_.contains(r.answeredSectionIds,s.id)){var u=s.validate(o);if(u)return this.initAnswers(0,{silent:!0}),!1}s.set(o,{silent:!0})}return this.set({page:r.page,answeredSectionIds:r.answeredSectionIds},t),!0}})})();var BackboneSurvey=BackboneSurvey||{};(function(){BackboneSurvey.Templates={SectionView:'<div class="<%- elPrefix %>question"><%= model.contents.question %></div><div id="<%- elPrefix %>error-<%- model.id %>" class="<%- elPrefix %>error"></div><div id="<%- elPrefix %>answer-<%- model.id %>" class="<%- elPrefix %>answer"></div>',TextAnswerView:'<%= model.contents.prefix %><input type="text" name="answer-<%- model.id %>"<% if (model.answers.length !== 0) { %> value="<%- model.answers[0] %>"<% } %>><%= model.contents.suffix %>',MultiAnswerView:'<dl><% _.each(model.fields, function(field, i) { %><dt><%= field.label %></dt><dd><input type="text" name="answer-<%- model.id %>-<%- i %>" value="<%- model.answers[i] %>"></dd><% }); %></dl>',OptionAnswerView:'<ul><% _.each(model.options, function(option, i) { %><li><input type="<%- multiple ? "checkbox" : "radio" %>" id="<%- elPrefix %>answer-<%- model.id %>-<%- i %>" name="answer-<%- model.id %>" data-answer-index="<%- i %>"><label for="<%- elPrefix %>answer-<%- model.id %>-<%- i %>"><%= option.label %></label><% if (option.sub) { %> <input type="text" name="sub-<%- model.id %>-<%- i %>" placeholder="<%- option.sub.placeholder %>"><% } %></li><% }); %></ul>',MatrixAnswerView:'<table><tr><td></td><% _.each(model.options, function(option, i) { %><td><%- option.label %></td><% }); %></tr><% _.each(model.fields, function(field, j) { %><tr><td><%- field.label %></td><% _.each(model.options, function(option, i) { %><td><input type="<%- multiple? "checkbox" : "radio" %>" name="answer-<%- model.id %>-<%- j %>" data-answer-index="<%- i %>"></td><% }); %></tr><% }); %></table>'}})();var BackboneSurvey=BackboneSurvey||{};(function(){BackboneSurvey.SurveyView=Backbone.View.extend({elPrefix:"survey-",rendered:!1,errors:{},_locked:!1,_valid:!1,templates:{error:"<ul><% _.each(errors, function(error) { %><li><%- error %></li><% }); %></ul>"},initialize:function(){this.$el.hide(),this.rendered=!1,this.errors={},this._locked=!1,this._valid=!1;var e={};e["click ."+this.elPrefix+"start"]="startPage",e["click ."+this.elPrefix+"prev"]="prevPage",e["click ."+this.elPrefix+"next"]="nextPage",this.delegateEvents(e),this.$title=this.$("."+this.elPrefix+"title"),this.$sections=this.$("#"+this.elPrefix+"sections"),this.sectionView={},this.listenTo(this.model,"change",this._render),this.listenTo(this.model,"completed",this._complete)},isLocked:function(){return this._locked},isValid:function(){return this._valid},beforeRender:function(e){var t=this;e.hide(0,function(){t.render()})},afterRender:function(e){var t=this;e.show(0,function(){t.rendered=!0})},_render:function(){this.rendered=!1,this._locked=!1,this._valid=!1,this.beforeRender(this.$el)},_complete:function(){this.$el.html(""),this._locked=!1,this.trigger("completed",this)},lock:function(){this._locked=!0;var e=this.model.currentSections(),t=this;_.each(e,function(e){var n=t.sectionViewMap[e.id];n&&n.answerView.lock()})},unlock:function(){this._locked=!1;var e=this.model.currentSections(),t=this;_.each(e,function(e){var n=t.sectionViewMap[e.id];n&&n.answerView.unlock()})},render:function(){this.$title.html(this.model.get("title")||""),this.$sections.html(""),this.sectionViewMap={};if(this.model.get("page")>0){var t=this,n=this.model.currentSections();_.each(n,function(n){var r=t.sectionViewMap[n.id]=new e({model:n,className:t.elPrefix+"section"});r.answerView.on("answer",function(){t.validate(),t.trigger("answer")}),r.answerView.on("lock",function(){t.lock()}),r.answerView.on("unlock",function(){t.unlock()}),r.render(),r.$("."+t.elPrefix+"error").html("").hide(),t.$sections.append(r.el)}),this.model.isFirstPage()?this.$("."+this.elPrefix+"prev").hide():this.$("."+this.elPrefix+"prev").show(),this.validate({silent:!0}),this.afterRender(this.$el)}return this},startPage:function(){if(this.isLocked())return;this.trigger("start",this)},prevPage:function(){if(this.isLocked())return;this.trigger("prev",this)},nextPage:function(){if(this.isLocked())return;if(!this.rendered)return;this.validate()?this.trigger("next",this):this.trigger("invalid",this)},validate:function(e){e=e||{},this.errors={};var t=!0,n=_.keys(this.sectionViewMap),r=this;return _.each(n,function(n){var i=r.model.sections.get(n);if(!i)return;i.clearAnswers();var s=r.sectionViewMap[n],o=s.$("."+r.elPrefix+"error");o.html("").hide(),i.set({answers:s.answers(),subAnswer:s.subAnswer()},{validate:!0}),i.validationError&&(t=!1,e.silent||(r.errors[i.id]=i.validationError,o.html(_.template(r.templates.error)({errors:r.errors[i.id]})).show()))}),this._valid=t,this._valid}});var e=BackboneSurvey.SectionView=Backbone.View.extend({tagName:"div",initialize:function(){this.elPrefix=this.elPrefix||"survey-",this.answerView=t.create(this),this.answerView.elPrefix=this.elPrefix},lock:function(){},unlock:function(){},render:function(){return this.$el.html(_.template(BackboneSurvey.Templates.SectionView)({elPrefix:this.elPrefix,model:this.model.toJSON()})),this.$("#"+this.elPrefix+"answer-"+this.model.id).html(this.answerView.render().el),this},answers:function(){return this.answerView?this.answerView.answers():[]},subAnswer:function(){return this.answerView?this.answerView.subAnswer():{}}}),t=BackboneSurvey.AnswerViewFactory={};t.create=function(e){var t=BackboneSurvey[e.model.get("view")];if(typeof t!="function")switch(e.model.get("type")){case BackboneSurvey.QuestionType.TEXT:t=BackboneSurvey.TextAnswerView;break;case BackboneSurvey.QuestionType.MULTI:t=BackboneSurvey.MultiAnswerView;break;case BackboneSurvey.QuestionType.RADIO:case BackboneSurvey.QuestionType.CHECKBOX:t=BackboneSurvey.OptionAnswerView;break;case BackboneSurvey.QuestionType.MATRIX:case BackboneSurvey.QuestionType.MATRIX_MULTI:t=BackboneSurvey.MatrixAnswerView;break;default:t=BackboneSurvey.NoneAnswerView}return new t({model:e.model,tagName:"div",className:e.elPrefix+"answer-item"})};var n=BackboneSurvey.NoneAnswerView=Backbone.View.extend({initialize:function(){this.elPrefix=this.elPrefix||"survey-"},lock:function(){},unlock:function(){},render:function(){return this},answers:function(){return[]},subAnswer:function(){return{}}}),r=BackboneSurvey.TextAnswerView=Backbone.View.extend({templateName:"TextAnswerView",initialize:function(){this.elPrefix=this.elPrefix||"survey-"},lock:function(){},unlock:function(){},render:function(){this.$el.html(_.template(BackboneSurvey.Templates[this.templateName])({model:this.model.toJSON()}));var e=this;return this.$('[name="answer-'+this.model.id+'"]').on("blur",function(){e.trigger("answer")}),this},answers:function(){var e=this.$('[name="answer-'+this.model.id+'"]').val();return _.isEmpty(e)?[]:[e]},subAnswer:function(){return{}}}),i=BackboneSurvey.MultiAnswerView=Backbone.View.extend({templateName:"MultiAnswerView",initialize:function(){this.elPrefix=this.elPrefix||"survey-"},lock:function(){},unlock:function(){},render:function(){this.$el.html(_.template(BackboneSurvey.Templates[this.templateName])({model:this.model.toJSON()}));var e=this;return this.$('[name^="answer-'+this.model.id+'-"]').on("blur",function(){e.trigger("answer")}),this},answers:function(){var e=[];return this.$('[name^="answer-'+this.model.id+'-"]').each(function(){e.push($(this).val())}),e},subAnswer:function(){return{}}}),s=BackboneSurvey.OptionAnswerView=Backbone.View.extend({templateName:"OptionAnswerView",multiple:!1,initialize:function(){this.elPrefix=this.elPrefix||"survey-",this.multiple=this.model.get("type").multiple()},_normalize:function(e){var t=this,n=this.model.get("singleOptions"),r=this.model.get("options");if(e.prop("checked")){var i=parseInt(e.attr("data-answer-index"),10),s=_.contains(n,r[i].value)?function(){var e=parseInt($(this).attr("data-answer-index"),10);return i!=e}:function(){var e=parseInt($(this).attr("data-answer-index"),10);return _.contains(n,r[e].value)};this.$("[data-answer-index]").filter(s).prop("checked",!1).removeAttr("checked")}var o=this.answers();_.each(r,function(e,n){t.$('input[name^="sub-'+t.model.id+"-"+n+'"]').prop("disabled",!_.contains(o,e.value))})},lock:function(){},unlock:function(){},render:function(){this.$el.html(_.template(BackboneSurvey.Templates[this.templateName])({elPrefix:this.elPrefix,multiple:this.multiple,model:this.model.toJSON()}));var e=this,t=this.model.get("answers")||[],n=this.model.get("options")||[],r=this.model.get("subAnswer")||{};return _.each(n,function(n,i){var s=e.$('[data-answer-index="'+i+'"]');_.contains(t,n.value)?s.prop("checked",!0).attr("checked","checked"):s.prop("checked",!1).removeAttr("checked");if(n.sub){var o=e.$('input[name="sub-'+e.model.id+"-"+i+'"]');o.attr("value",r[n.value]||"")}}),this.$('input[name^="answer-"]').each(function(){e._normalize($(this))}).on("change",function(){e._normalize($(this)),e.trigger("answer")}),this},answers:function(){var e=[],t=this.model.get("options")||[];return this.$('input[name="answer-'+this.model.id+'"]').each(function(){var n=$(this);if(!n.prop("checked"))return;var r=parseInt(n.attr("data-answer-index"),10);e.push(t[r].value)}),e},subAnswer:function(){var e={},t=this.model.get("options"),n=this.answers(),r=this;return _.each(t,function(t,i){if(!t.sub)return;if(!_.contains(n,t.value))return;var s=r.$('input[name="sub-'+r.model.id+"-"+i+'"]');_.isEmpty(s.val())||(e[t.value]=s.val())}),e}}),o=BackboneSurvey.MatrixAnswerView=Backbone.View.extend({templateName:"MatrixAnswerView",multiple:!1,initialize:function(){this.elPrefix=this.elPrefix||"survey-",this.multiple=this.model.get("type").multiple()},_normalize:function(e){var t=this.model.get("singleOptions"),n=this.model.get("options");if(e.prop("checked")){var r=parseInt(e.attr("data-answer-index"),10),i=_.contains(t,n[r].value)?function(){var e=parseInt($(this).attr("data-answer-index"),10);return r!=e}:function(){var e=parseInt($(this).attr("data-answer-index"),10);return _.contains(t,n[e].value)};this.$('input[name="'+e.attr("name")+'"]').filter(i).prop("checked",!1).removeAttr("checked")}},lock:function(){},unlock:function(){},render:function(){this.$el.html(_.template(BackboneSurvey.Templates[this.templateName])({elPrefix:this.elPrefix,multiple:this.multiple,model:this.model.toJSON()}));var e=this,t=this.model.get("fields"),n=this.model.get("answers")||[],r=this.model.get("options")||[];return _.each(t,function(t,i){n[i]=n[i]||[],_.each(r,function(t,r){var s=e.$('[name="answer-'+e.model.id+"-"+i+'"]'+'[data-answer-index="'+r+'"]');_.contains(n[i],t.value)?s.prop("checked",!0).attr("checked","checked"):s.prop("checked",!1).removeAttr("checked")})}),this.$('input[name^="answer-"]').on("change",function(){e._normalize($(this)),e.trigger("answer")}),this},answers:function(){var e=[],t=this,n=this.model.get("fields"),r=this.model.get("options")||[];return _.each(n,function(n,i){e[i]=[],this.$('input[name="answer-'+t.model.id+"-"+i+'"]').each(function(){var t=$(this);if(!t.prop("checked"))return;var n=parseInt(t.attr("data-answer-index"),10);e[i].push(r[n].value)})}),e},subAnswer:function(){return{}}})})();