var BackboneSurvey=BackboneSurvey||{};(function(){BackboneSurvey.VERSION="0.0.0",BackboneSurvey.Extendable={extend:Backbone.Model.extend}})();var BackboneSurvey=BackboneSurvey||{};(function(){var e=function(){};BackboneSurvey.AnswerType={},BackboneSurvey.AnswerType.NONE=new e,BackboneSurvey.AnswerType.TEXT=new e,BackboneSurvey.AnswerType.OPTION=new e;var t=function(e,t){this._answerType=e,this._multiple=t};t.prototype={answerType:function(){return this._answerType},multiple:function(){return this._multiple}},BackboneSurvey.QuestionType={},BackboneSurvey.QuestionType.NONE=new t(BackboneSurvey.AnswerType.NONE,!1),BackboneSurvey.QuestionType.TEXT=new t(BackboneSurvey.AnswerType.TEXT,!1),BackboneSurvey.QuestionType.RADIO=new t(BackboneSurvey.AnswerType.OPTION,!1),BackboneSurvey.QuestionType.CHECKBOX=new t(BackboneSurvey.AnswerType.OPTION,!0)})();var BackboneSurvey=BackboneSurvey||{};(function(){var e=BackboneSurvey.ValidationResult=function(e){this.message=e||""};e.prototype={valid:!0},_.extend(e,BackboneSurvey.Extendable),e.OK=e.extend({valid:!0}),e.Error=e.extend({valid:!1});var t=BackboneSurvey.Validator=function(e){this.attributes=e||{}};t.prototype={validate:function(t,n){return new e.OK},message:function(e){return e=e||{},_.isString(this.attributes.template)?_.template(this.attributes.template)(_.extend(this.attributes,e)):this.attributes.message||""}},_.extend(t,BackboneSurvey.Extendable),BackboneSurvey.RequiredValidator=t.extend({validate:function(t,n){var r=_.isArray(t)?t:[t],i;if(r.length===0)i=new e.Error(this.message());else{var s=this;_.each(r,function(t){if(i)return;_.isNumber(t)&&(t=t.toString()),_.isEmpty(t)&&(i=new e.Error(s.message()))}),i||(i=new e.OK)}return i}}),BackboneSurvey.RangeLengthValidator=t.extend({validate:function(t,n){var r=_.isArray(t)?t:[t],i,s=this;return _.each(r,function(t){if(i)return;_.isNumber(t)&&(t=t.toString());var n=_.isNumber(s.attributes.min)?s.attributes.min:null,r=_.isNumber(s.attributes.max)?s.attributes.max:null;if(n&&n>t.length||r&&r<t.length)i=new e.Error(s.message())}),i||(i=new e.OK),i}})})();var BackboneSurvey=BackboneSurvey||{};(function(){var e=BackboneSurvey.Section=Backbone.Model.extend({constructor:function(){Backbone.Model.apply(this,arguments)},defaults:{page:0,type:BackboneSurvey.QuestionType.NONE,question:"",label:"",guide:"",options:[],textOptions:[],singleOptions:[],optionAnswers:[],textAnswers:[],defaultOptionAnswers:[],defaultTextAnswers:[],rules:[],routeDependencies:[]},set:function(e,t,n){if(e===null)return this;typeof e=="object"?(attrs=e,n=t):(attrs={})[e]=t,typeof attrs.id!="undefined"&&(attrs.id=attrs.id.toString()),typeof attrs.page!="undefined"&&(attrs.page=_.isNumber(attrs.page)?parseInt(attrs.page,10):0);if(typeof attrs.options!="undefined"){var r=attrs.options||[];attrs.options=[],_.each(r,function(e){typeof e!="object"&&(e={value:e.toString(),label:e.toString()}),attrs.options.push(e)})}Backbone.Model.prototype.set.call(this,attrs,n)},validate:function(e,t){var n=[],r=this.answers(e),i=this;_.each(this.attributes.rules,function(e){if(n.length>0)return;var t=e.validate(r,i.attributes);t.valid||n.push(t.message)});if(n.length>0)return n},answers:function(e){e=e||this.attributes;var t=[];switch(this.get("type")){case BackboneSurvey.QuestionType.TEXT:t=e.textAnswers;break;case BackboneSurvey.QuestionType.RADIO:case BackboneSurvey.QuestionType.CHECKBOX:t=e.optionAnswers;break;default:}return t},clearAnswers:function(){this.set({optionAnswers:[],textAnswers:[]},{silent:!0})}}),t=BackboneSurvey.Sections=Backbone.Collection.extend({model:e,firstPage:function(){return this.reduce(function(e,t){var n=t.get("page");return e===0||e>n?n:e},0)},lastPage:function(){return this.reduce(function(e,t){var n=t.get("page");return e===0||e<n?n:e},0)},prevPage:function(e){var t=[];return this.each(function(n){var r=n.get("page");r<e&&t.push(r)}),t=_.sortBy(t,function(e){return-1*e}),t.length>0?t[0]:e===0?this.firstPage():e},nextPage:function(e){var t=[];this.each(function(n){var r=n.get("page");r>e&&t.push(r)}),t=_.sortBy(t,function(e){return e});var n=this.lastPage();return t.length>0?t[0]:e===0||n<e?n:e}}),n=BackboneSurvey.Survey=Backbone.Model.extend({constructor:function(){this.sections=new t,Backbone.Model.apply(this,arguments)},defaults:{title:"",page:0},parse:function(e,t){return this.sections.reset(_.filter(e.sections||[],function(e){return e.id.toString().match(/^[-_0-9a-zA-Z]+$/)})),e.survey},startPage:function(){this.sections.each(function(e){e.clearAnswers(),e.set({optionAnswers:e.get("defaultOptionAnswers"),textAnswers:e.get("defaultTextAnswers")})});var e=this.sections.firstPage();this.set({page:e})},prevPage:function(){var e=this.sections.prevPage(this.get("page"));e!=this.get("page")&&this.set({page:e})},nextPage:function(){var e=this.sections.nextPage(this.get("page"));e!=this.get("page")&&this.set({page:e})},isFirstPage:function(){return this.get("page")===this.sections.firstPage()},isLastPage:function(){return this.get("page")===this.sections.lastPage()},answers:function(){var e=[];return this.sections.each(function(t){if(t.get("type")===BackboneSurvey.QuestionType.NONE)return;e.push({id:t.id,textAnswers:t.get("textAnswers"),optionAnswers:t.get("optionAnswers")})}),e}});BackboneSurvey.survey=new n})();var BackboneSurvey=BackboneSurvey||{};(function(){BackboneSurvey.SurveyView=Backbone.View.extend({elPrefix:"survey-",templates:{error:"<ul><% _.each(errors, function(error) { %><li><%- error %></li><% }); %></ul>"},initialize:function(){this.$el.hide();var e={};e["click ."+this.elPrefix+"start"]="startPage",e["click ."+this.elPrefix+"prev"]="prevPage",e["click ."+this.elPrefix+"next"]="nextPage",this.delegateEvents(e),this.$title=this.$("."+this.elPrefix+"title"),this.$sections=this.$("#"+this.elPrefix+"sections"),this.sectionView={},this.listenTo(this.model,"change",this.render)},render:function(){BackboneSurvey.logger&&BackboneSurvey.logger.debug(["SurveyView#render",this.model]),this.$title.html(this.model.get("title")||""),this.$sections.html(""),this.sectionViewMap={};if(this.model.get("page")>0){var t=this;this.model.sections.each(function(n){if(n.get("page")!==t.model.get("page"))return;var r=t.sectionViewMap[n.id]=new e({model:n,className:t.elPrefix+"section"});r.render(),r.$("."+t.elPrefix+"error").html("").hide(),t.$sections.append(r.el)}),this.model.isFirstPage()?this.$("."+this.elPrefix+"prev").hide():this.$("."+this.elPrefix+"prev").show(),this.$el.show()}else this.$el.hide();return this},startPage:function(){this.model.startPage()},prevPage:function(){this.model.prevPage()},nextPage:function(){var e=!0;for(var t in this.sectionViewMap){var n=this.model.sections.get(t);if(!n)return;n.clearAnswers();var r=this.sectionViewMap[t],i=r.$("."+this.elPrefix+"error");i.html("").hide(),n.set({textAnswers:r.textAnswers(),optionAnswers:r.optionAnswers()},{validate:!0}),n.validationError&&(e=!1,i.html(_.template(this.templates.error)({errors:n.validationError})).show())}e&&(this.model.isLastPage()?(this.$el.html(""),this.trigger("completed",this)):this.model.nextPage())}});var e=BackboneSurvey.SectionView=Backbone.View.extend({tagName:"div",template:'<div class="<%- elPrefix %>question"><span class="<%- elPrefix %>question-title"><%= model.question %></span></div><div id="<%- elPrefix %>error-<%- model.id %>" class="<%- elPrefix %>error"></div><div id="<%- elPrefix %>answer-<%- model.id %>" class="<%- elPrefix %>answer"></div>',initialize:function(){this.elPrefix=this.elPrefix||"survey-",this.answerView=t(this)},render:function(){return this.$el.html(_.template(this.template)({elPrefix:this.elPrefix,model:this.model.toJSON()})),this.$("#"+this.elPrefix+"answer-"+this.model.id).html(this.answerView.render().el),this},textAnswers:function(){return this.answerView?this.answerView.textAnswers():[]},optionAnswers:function(){return this.answerView?this.answerView.optionAnswers():[]}}),t=BackboneSurvey.AnswerViewFactory=function(e){var t;switch(e.model.get("type")){case BackboneSurvey.QuestionType.TEXT:t=BackboneSurvey.TextAnswerView;break;case BackboneSurvey.QuestionType.RADIO:t=BackboneSurvey.RadioAnswerView;break;case BackboneSurvey.QuestionType.CHECKBOX:t=BackboneSurvey.CheckboxAnswerView;break;default:t=BackboneSurvey.NoneAnswerView}return new t({model:e.model,tagName:"div",className:e.elPrefix+"answer-item"})},n=BackboneSurvey.NoneAnswerView=Backbone.View.extend({render:function(){return this},textAnswers:function(){return[]},optionAnswers:function(){return[]}}),r=BackboneSurvey.TextAnswerView=Backbone.View.extend({template:'<%= label %><input type="text" name="answer-<%- id %>"<% if (textAnswers.length !== 0) { %> value="<%- textAnswers[0] %>"<% } %>><%= guide %>',render:function(){return this.$el.html(_.template(this.template)(this.model.toJSON())),this},textAnswers:function(){var e=this.$('[name="answer-'+this.model.id+'"]').val();return _.isEmpty(e)?[]:[e]},optionAnswers:function(){return[]}}),i={render:function(){this.$el.html(_.template(this.template)(this.model.toJSON()));var e=this,t=function(){e.normalize($(this))};return this.$('input[name^="answer-"]').each(t).on("change",t),this},normalize:function(e){var t=this.model.get("singleOptions");if(e.prop("checked")){var n=e.val(),r=_.contains(t,n)?function(){return this.value!=n}:function(){return _.contains(t,this.value)};this.$('input[name^="answer-"]').filter(r).prop("checked",!1).removeAttr("checked")}},textAnswers:function(){return[]},optionAnswers:function(){var e=[];return this.$('[name="answer-'+this.model.id+'"]').each(function(){var t=$(this);t.prop("checked")&&e.push(t.val())}),e}},s=BackboneSurvey.RadioAnswerView=Backbone.View.extend({template:'<ul><% _.each(options, function(option) { %><li><label><input type="radio" name="answer-<%- id %>" value="<%- option.value %>"<% if (_.contains(optionAnswers, option.value)) { %> checked="checked"<% } %>><%- option.label %></label></li><% }); %></ul>'});_.extend(s.prototype,i);var o=BackboneSurvey.CheckboxAnswerView=Backbone.View.extend({template:'<ul><% _.each(options, function(option) { %><li><label><input type="checkbox" name="answer-<%- id %>" value="<%- option.value %>"<% if (_.contains(optionAnswers, option.value)) { %> checked="checked"<% } %>><%- option.label %></label></li><% }); %></ul>'});_.extend(o.prototype,i)})();